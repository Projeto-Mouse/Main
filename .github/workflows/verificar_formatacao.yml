name: Verificador de Formatação (C++, C#, GDScript)

on:
  # Roda em pushes DIRETOS para main ou staging
  push:
    branches:
      - main
      - staging
  
  # Roda em PRs que miram main ou staging
  pull_request:
    branches:
      - main
      - staging

jobs:
  # Job 1: Verificador de GDScript
  check_gdscript:
    name: Verificar Formatação GDScript
    runs-on: ubuntu-latest
    steps:
      - name: 1. Baixar o código (Checkout)
        uses: actions/checkout@v4
          
      - name: 2. Verificar se existem arquivos GDScript
        id: find_gd_files
        run: |
          if find . -type f -name "*.gd" | read; then
            echo "files_found=true" >> $GITHUB_OUTPUT
          else
            echo "Nenhum arquivo .gd encontrado. Pulando."
            echo "files_found=false" >> $GITHUB_OUTPUT
          fi
          
      - name: 3. Rodar Formatador (gdformat - 4 espaços)
        if: steps.find_gd_files.outputs.files_found == 'true'
        id: gdformat_check
        run: |
          ERROR_FLAG=0
          echo "Verificando formatação (indentação/espaços) com gdformat..."
          
          if ! OUTPUT=$(gdformat --check . --line-length 120 2>&1); then
            echo "$OUTPUT"
            # Cria anotações para arquivos não formatados
            echo "$OUTPUT" | grep 'need reformatting' | while IFS= read -r line; do
              FILE_PATH=$(echo "$line" | awk '{print $1}')
              echo "::error file=$FILE_PATH::Falha no gdformat. Arquivo precisa ser reformatado."
            done
            echo "::error file=.editorconfig,line=1::Falha na formatação GDScript (gdformat). Verifique os arquivos acima."
            ERROR_FLAG=1
          fi
          
          echo "error_flag=$ERROR_FLAG" >> $GITHUB_OUTPUT
          
      - name: 4. Rodar Linter (gdlint - Nomenclatura)
        if: steps.find_gd_files.outputs.files_found == 'true'
        id: gdlint_check
        run: |
          ERROR_FLAG=${{ steps.gdformat_check.outputs.error_flag }}
          echo "Verificando convenções de nomenclatura (nomes de arquivos/classes/funções) com gdlint..."
          
          if ! OUTPUT=$(gdlint . 2>&1); then
            echo "$OUTPUT"
            # Cria anotações para erros de linting
            echo "$OUTPUT" | grep -E '(.+):([0-9]+):[0-9]+:' | while IFS= read -r line; do
              FILE_PATH=$(echo "$line" | cut -d ':' -f 1)
              LINE_NUMBER=$(echo "$line" | cut -d ':' -f 2)
              MESSAGE=$(echo "$line" | cut -d ':' -f 4-)
              echo "::error file=$FILE_PATH,line=$LINE_NUMBER::$MESSAGE"
            done
            # Mensagem de falha para garantir o registro
            echo "::error file=.gdlintrc,line=1::Falha nas convenções de nomenclatura GDScript (gdlint). Verifique as anotações detalhadas acima."
            ERROR_FLAG=1
          fi
          
          echo "error_flag=$ERROR_FLAG" >> $GITHUB_OUTPUT

      - name: 5. Finalizar e Reportar Erros (GDScript)
        if: steps.find_gd_files.outputs.files_found == 'true'
        run: |
          # Se o gdformat ou gdlint falharam, encerra com erro
          if [ ${{ steps.gdlint_check.outputs.error_flag }} -eq 1 ]; then
            echo "Erros de formatação/linting GDScript encontrados. Encerrando Job."
            exit 1
          fi

---

# Job 2: Verificador de C#
  check_csharp:
    name: Verificar Formatação C# (.NET)
    runs-on: ubuntu-latest
    steps:
      - name: 1. Baixar o código (Checkout)
        uses: actions/checkout@v4
        
      - name: 2. Verificar se existem arquivos C#
        id: find_cs_files
        run: |
          if find . -maxdepth 5 -type f \( -name "*.csproj" -o -name "*.sln" \) | read; then
            echo "files_found=true" >> $GITHUB_OUTPUT
          else
            echo "Nenhum arquivo .csproj ou .sln encontrado. Pulando."
            echo "files_found=false" >> $GITHUB_OUTPUT
          fi
          
      - name: 3. Verificar formatação C# (se houver arquivos)
        if: steps.find_cs_files.outputs.files_found == 'true'
        id: dotnet_format_check
        run: |
          ERROR_FLAG=0
          echo "Arquivos .csproj/.sln encontrados. Verificando formatação..."
          workspace_file=$(find . -maxdepth 5 -type f \( -name "*.sln" -o -name "*.csproj" \) -print -quit)
          echo "Verificando workspace: $workspace_file"

          if ! OUTPUT=$(dotnet format "$workspace_file" --verify-no-changes --verbosity diagnostic 2>&1); then
            echo "$OUTPUT"
            # Cria anotações para arquivos não formatados (apenas o arquivo, sem linha)
            echo "$OUTPUT" | grep -E 'Formatted file | Would fix: ' | while IFS= read -r line; do
              FILE_PATH=$(echo "$line" | awk '{print $NF}' | sed 's/.$//')
              if [[ "$FILE_PATH" != "" ]]; then
                  echo "::error file=$FILE_PATH::Falha no dotnet format. Arquivo precisa de formatação."
              fi
            done
            
            # Mensagem de falha final
            echo "::error file=.editorconfig,line=1::Falha na formatação C#. Os arquivos não formatados estão listados nas anotações acima."
            ERROR_FLAG=1
          fi
          
          echo "error_flag=$ERROR_FLAG" >> $GITHUB_OUTPUT
          
      - name: 4. Finalizar e Reportar Erros (C#)
        if: steps.find_cs_files.outputs.files_found == 'true'
        run: |
          # Se o dotnet format falhou, encerra com erro
          if [ ${{ steps.dotnet_format_check.outputs.error_flag }} -eq 1 ]; then
            echo "Erros de formatação C# encontrados. Encerrando Job."
            exit 1

          fi

---

# Job 3: Verificador de C++
  check_cpp:
    name: Verificar Formatação C++
    runs-on: ubuntu-latest
    steps:
      - name: 1. Baixar o código (Checkout)
        uses: actions/checkout@v4
        
      - name: 2. Verificar se existem arquivos C++
        id: find_cpp_files
        run: |
          if find . -type f \( -name "*.h" -o -name "*.cpp" \) | read; then
            echo "files_found=true" >> $GITHUB_OUTPUT
          else
            echo "Nenhum arquivo .h ou .cpp encontrado. Pulando."
            echo "files_found=false" >> $GITHUB_OUTPUT
          fi
          
      - name: 3. Rodar clang-format-lint (se houver arquivos)
        if: steps.find_cpp_files.outputs.files_found == 'true'
        id: clang_lint
        # Essa Ação já tem o comportamento de encontrar todos os erros antes de sinalizar a falha.
        uses: DoozyX/clang-format-lint-action@v0.17
        with:
          source: '.'
          extensions: 'h,cpp'
          clangFormatVersion: 17
          style: 'file'
        continue-on-error: true # Continua a rodar mesmo se encontrar erros
        
      - name: 4. Verificar falha do clang-format
        if: steps.find_cpp_files.outputs.files_found == 'true' && steps.clang_lint.outcome == 'failure'
        run: |
          # Se a ação falhou (outcome == 'failure'), significa que encontrou erros.
          # Força o job a falhar neste ponto, após todas as anotações terem sido criadas.
          echo "::error file=.clang-format,line=1::Falha na formatação C++. Verifique as anotações detalhadas (arquivo e linha) criadas pela ação clang-format-lint-action."
          exit 1
